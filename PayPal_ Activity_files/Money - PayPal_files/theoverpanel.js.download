define(["jquery","underscore","BaseView","backbone","widget/sessionTimer"],function(e,t,n,r,i){"use strict";var s=n.extend({el:"#overpanel",events:{"click .close":"abortOverpanel",focus:"setTabables",animationend:"animationEnd",webkitAnimationEnd:"animationEnd",oAnimationEnd:"animationEnd",MSAnimationEnd:"animationEnd"},initialize:function(){this.$body=e("body"),this.canUseEsc=!0,this.isOpen=!1,this.listenTo(r,"pushedState",this.setPusher),this.listenTo(r,"toggleLoading",this.toggleLoading),this.listenTo(r,"overpanel:hide",this.hideOverpanel)},beforeRender:function(){this.view.beforeRender()},afterRender:function(){this.view.afterRender(),this.showOverpanel()},setPusher:function(e){this.$pusher=e},toggleLoading:function(e){return this.isOpen&&this.shouldListenToEsc(!e),this.$el.toggleClass("hasSpinner",e),this},exists:function(){return this.$el.length?!0:!1},setContent:function(t,n){return this.view=t,this.view.setElement(this.$el),this.template=t.template,t.model?this.model=t.model:this.collection=t.collection,this.serialize=e.proxy(t.serialize,t),(n===undefined||n)&&this.render(),this},setTabables:function(){this.$tabables=this.$el.find("a, button, input, select, textarea, [tabindex=0]").filter(":visible:not(:disabled)"),this.$footerLinks=e(".footer a").filter(":visible")},manageFocus:function(t){var n=e(document.activeElement),r=n.is(this.$tabables.eq(0)),i=n.is(this.$tabables.eq(this.$tabables.length-1)),s=n.is(this.$footerLinks.eq(0)),o=n.is(this.$footerLinks.eq(this.$footerLinks.length-1));t.which===9&&(t.shiftKey?(r&&(t.preventDefault(),this.$footerLinks.eq(this.$footerLinks.length-1).focus()),s&&(t.preventDefault(),this.$tabables.eq(this.$tabables.length-1).focus())):(o&&(t.preventDefault(),this.$el.focus()),i&&(t.preventDefault(),this.$footerLinks.eq(0).focus())))},showOverpanel:function(){this.$body.addClass("overpanelOpen"),this.$el.removeClass("fadeOutDownBig hide"),this.isOpen||this.$el.addClass("fadeInUpBig"),this.$el.attr("aria-hidden",!1),this.isOpen=!0},animationEnd:function(){var e=this.$el;this.isOpen?(r.trigger("shouldHideContents",!0),e.focus(),this.shouldApplyA11Y(!0),this.$focusOnClose=this.$pusher,this.canUseEsc&&this.shouldListenToEsc(!0)):this.hide()},hide:function(){this.$el.addClass("hide").removeClass("fadeOutDownBig"),this.$focusOnClose=this.$focusOnClose||this.$body,this.$focusOnClose.focus()},abortOverpanel:function(){this.sessionTimerView.stopTimers(),r.trigger("overpanel:abort"),this.hideOverpanel.apply(this,arguments)},hideOverpanel:function(t,n){this.sessionTimerView.stopTimers(),n=n||{};var i=this.$(".close");t&&t.preventDefault(),this.isOpen&&(this.isOpen=!1,this.$body.removeClass("overpanelOpen"),this.$el.removeClass("fadeInUpBig").addClass("fadeOutDownBig"),this.$el.attr("aria-hidden",!0),this.canUseEsc=!0,setTimeout(e.proxy(function(){this.hide()},this),500)),this.shouldListenToEsc(!1),this.shouldApplyA11Y(!1),i.length!==0&&!n.stopAutoNav&&r.history.navigate(i.attr("href").slice(12),{trigger:!0}),r.trigger("shouldHideContents",!1),r.trigger("overpanel:close")},closeOverpanel:function(e){e.which===27&&(this.abortOverpanel(),r.trigger("trackLink",this.$(".close")))},shouldListenToEsc:function(t){t?this.$body.on("keydown",e.proxy(this.closeOverpanel,this)):this.$body.off("keydown",e.proxy(this.closeOverpanel,this))},shouldApplyA11Y:function(t){t?e("#overpanel, #footer").on("keydown",e.proxy(this.manageFocus,this)):e("#overpanel, #footer").off("keydown",e.proxy(this.manageFocus,this))}});return new s});