define(["jquery","BaseView","backbone","underscore","widget/alertMsg","widget/clearInput"],function(e,t,n,r,i,s){"use strict";var o=t.extend({timer:null,customRule:null,next:null,submitBtn:null,checkInput:null,preValue:null,timeouts:[],events:{'change select[required="required"]:visible':"validating",'focus input[required="required"]:visible':"startValidating",'focusout input[required="required"]:visible':"stopValidating","click .validateBeforeSubmit":"validateBeforeSubmit"},initialize:function(e){this.next=e.next,this.alertMsg=new i,this.customRule=e.customRule,this.checkInput=e.checkInput,this.clearInput=new s({el:this.$el})},validating:function(t){var r=this.validateFields(this.$('input[required="required"]:visible'),this.$('select[required="required"]:visible'),t),i=e(this.checkInput);this.next&&this.next(r),this.checkInput&&this.preValue!==i.val()&&(this.preValue=i.val(),i.parent().removeClass("hasError"),this.validateFields(this.checkInput)&&n.trigger("inputValid"))},validateBeforeSubmit:function(t){var n=this.$("textarea[required]:visible, input[required]:visible"),r=this.$("select[required]:visible"),i=this.validateFields(n,r);return i?!0:(t&&(t.preventDefault(),t.stopPropagation()),setTimeout(e.proxy(function(){this.validateFields(n,r,!0,!0),this.trackErrors(n,r)},this),100),!1)},trackErrors:function(t,r){var i=t.add(r),s;i.each(e.proxy(function(t,r){s=e(r).parent(".hasError"),s&&s.length>0&&n.trigger("trackError",{message:e(r).siblings(".help-error").text(),fieldId:r.id})},this))},validateTimer:function(){this.validating(),this.timeouts.push(setTimeout(e.proxy(function(){this.validateTimer()},this),300))},startValidating:function(){this.validateTimer()},stopValidating:function(){var t=e(this.checkInput).parent(),n;this.trimInput(),setTimeout(e.proxy(function(){this.validating(!0)},this),50),t.hasClass("hasError")&&setTimeout(function(){t.addClass("hasError")},0);for(n=0;n<this.timeouts.length;n++)clearTimeout(this.timeouts[n])},validateFields:function(t,n,i,s){var o=!0;return n&&n.each(function(){e(this).parent().parent().removeClass("hasError"),e(this).val()==="-1"&&(o=!1,s&&e(this).parent().parent().addClass("hasError"))}),t.each(r.bind(function(t,n){var r=e(n),u=r.parent(),a=u.find(".help-error"),f;!r.val()||r.is(":checkbox")&&!r.attr("checked")?(o=!1,u.removeClass("hasError"),s&&this.initInputErrorState(u)):u.hasClass("hasError")?o=!1:(f=e.trim(r.val()),this.checkInputValidation(r,f)||(o=!1,s||i&&f!==""&&this.initInputErrorState(u,a)),o&&this.removeInputErrorState(u,a))},this)),o&&this.customRule&&(o=this.customRule(o)),o},checkInputValidation:function(e,t){return this.checkSkipValidation(e)?!0:this.checkInputPattern(e,t)&&this.checkInputDataMin(e,t)&&this.checkInputMin(e,t)&&this.checkInputMax(e,t)&&this.checkInputMaxLength(e,t)?!0:!1},checkSkipValidation:function(e){return e.data("skip-validate")===!0},initInputErrorState:function(e,t){e.addClass("hasError"),t&&t.addClass("open")},removeInputErrorState:function(e,t){e.removeClass("hasError"),t.removeClass("open")},checkInputPattern:function(e,t){if(e.attr("pattern")){var n=new RegExp("^"+e.attr("pattern")+"$");if(!n.test(t))return!1}return!0},checkInputDataMin:function(e,t){return e.data("min")&&t.length<e.data("min")?!1:!0},getRegExp:function(e,t){var n=t||e.data("decimal-separator")||".",r={decimalSeparator:n,regexPattern:new RegExp("[^0-9\\"+n+"]","g")};return r},getRawValue:function(e,t){return parseFloat(e.replace(t.regexPattern,"").replace(t.decimalSeparator,"."))},checkInputMin:function(e,t,n){if(e.attr("min")){var r=this.getRegExp(e,n),i=this.getRawValue(t,r),s=this.getRawValue(e.attr("min"),r);if(parseFloat(i)<parseFloat(s))return!1}return!0},checkInputMax:function(e,t,n){if(e.attr("max")){var r=this.getRegExp(e,n),i=this.getRawValue(t,r),s=this.getRawValue(e.attr("max"),r);if(i>s)return!1}return!0},checkInputMaxLength:function(e,t){return e.attr("maxlength")&&t.length>e.attr("maxlength")?!1:!0},trimInput:function(){var t=this.$("input:visible");t.each(function(){var t=e(this);t.val(e.trim(t.val()))})},showError:function(e){this.$(".alertMsg").remove(),this.$el.prepend(this.alertMsg.setMessage(e).el)}});return o});