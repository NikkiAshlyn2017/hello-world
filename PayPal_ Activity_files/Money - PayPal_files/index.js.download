define(["jquery","backbone","bootstrap","lap","businessHelper","overpanel","Tutorial","widget/sessionTimer","widget/theoverpanel","view/overpanel/bank/addBank","view/overpanel/bank/bankDetails","view/money/inc/cards","view/money/inc/savedOfferDetails","view/money/inc/savedOffer","view/money/inc/giftCards","widget/alertDialogs","widget/alertMsg","BaseView","lib/business/businessHelper","lib/clamp","collection/savedOffers","popover","view/common/ppwcTileHelper","underscore","view/money/inc/requestIncreaseModalInfo","model/populateChoice"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N){"use strict";var C=g.extend({el:"#moneyPage",csrf:e("#_csrf"),username:e("#username"),bankCount:e("#totalBankCount"),moneymodule:e("#banks").data("moneymodel"),savedoffers:e("#savedOffers").data("offermodel"),deviceType:e("#savedOffers").data("devicetype"),icPlusBannerRecorded:!1,fptiPage:"main:businessweb:money::main:::icplus-banner::",pageGroup:"main:businessweb:money::main",template:"bizexpnodeweb/public/templates/money/index.dust",vars:{},events:{"click .addFI":"addBank","click .addDetails":"bankDetails","click .modal-content .close":"hideIframe","click a#money-transfer-link":"showMoneyTransferModal","click a.savedOffersLink":"openSavedOfferDetails","click a#giftCardDetails":"showGiftCardModal","click #addGiftCardLink":"addGiftCards","click a.groupedLinks":"trackClick","click .workingcapital-tile-on-money-page a":"trackPPWCWidgetClickMoneyPage","click a.requestIncreaseLink":"showRequestIncreaseModal","click #caret-up-click":"toggleHoldSection","click #caret-down-click":"toggleHoldSection"},initialize:function(){var n=new s;this.listenTo(t,"closeAddBankOverpanel",this.closeAddBankOverpanel),this.listenTo(t,"renderBanks",this.renderBanks),this.listenTo(t,"showBankDetailsError",this.showBankDetailsError),this.listenTo(t,"toggleLoading",this.toggleLoading),this.listenTo(t,"removeAndReloadOffers",this.removeAndReloadOffers),this.alertView=this.alertView||new v,this.alertMsg=this.alertMsg||new m,this.initAddBank(),this.initCardsView(),this.initGiftCardView(),this.initMoneyModal(),this.sessionTimerView=this.sessionTimerView||new u,a.sessionTimerView=this.sessionTimerView,this.savedOfferCollection=new w(this.savedoffers),this.textClamp(".bank-info .cardName",2);if(e("#showModal").val()==="true"){var r="/moneytransfer";this.openMoneyModal(r)}!this.icPlusBannerRecorded&&e(".ic-plus-banner").length&&(y.fptiRecordImpression(this.fptiPage,this.pageGroup,this.template),this.icPlusBannerRecorded=!0),S.trackPPWCWidgetImpressionMoneyPage(),e(".confirm-fee").click(function(e){var t=e.currentTarget.className;y.fptiRecordClick(this.fptiPage,this.pageGroup,this.template,t)}.bind(this)),x.extend(this,S.mixin)},textClamp:function(t,n){e(t).each(function(e,t){b(t,{clamp:n})})},hideIframe:function(){t.history.navigate("/money",{trigger:!0,replace:!0})},initAddBank:function(){this.addBankView||(this.addBankView=new f,this.addBankView.model=new t.Model({username:this.username.val()}),this.addBankView.template="bank/overpanel/addBank_euro")},renderAddBank:function(){this.bankCount=e("#totalBankCount");if(!(this.bankCount.val()>=8)){a.setContent(this.addBankView);return}this.alertView.showAlert("meetMaxBank"),t.history.navigate("/money",{trigger:!0,replace:!0})},renderBankDetails:function(n){this.bankDetailsView||(this.bankDetailsView=new l,this.bankDetailsView.alertView=this.alertView);var r;this.moneymodule==="undefined"&&(this.moneymodule=e("#banks").data("moneymodel"),this.bankCount=e("#totalBankCount"));for(r=0;r<this.bankCount.val();r++)if(this.moneymodule[r].fiId===n){this.bankDetailsView.model?this.bankDetailsView.model.set(this.moneymodule[r]):this.bankDetailsView.model=new t.Model(this.moneymodule[r]);break}a.setContent(this.bankDetailsView);return},bankDetails:function(n){n.preventDefault();var r=e(n.currentTarget).attr("data-bank-id");t.history.navigate("money/bankDetails?id="+r,{trigger:!0}),this.bankDetailsView||(this.bankDetailsView=new l,this.bankDetailsView.alertView=this.alertView);var i;this.moneymodule==="undefined"&&(this.moneymodule=e("#banks").data("moneymodel"),this.bankCount=e("#totalBankCount"));for(i=0;i<this.bankCount.val();i++)if(this.moneymodule[i].fiId===r){this.bankDetailsView.model?this.bankDetailsView.model.set(this.moneymodule[i]):this.bankDetailsView.model=new t.Model(this.moneymodule[i]);break}a.setContent(this.bankDetailsView);return},addBank:function(n){n.preventDefault(),t.history.navigate("/money/add/bank",{trigger:!0}),this.bankCount=e("#totalBankCount");if(!(this.bankCount.val()>=8)){this.addBankView||(this.addBankView=new f,this.addBankView.model=new t.Model({username:this.username.val()}),this.addBankView.template="bank/overpanel/addBank_euro"),a.setContent(this.addBankView);return}this.alertView.showAlert("meetMaxBank"),t.history.navigate("/money",{trigger:!0,replace:!0})},renderBanks:function(){t.trigger("toggleLoading",!0);var n;n=new g,n.model=new t.Model,n.template="money/inc/banks";var r;r=new t.Model,r.url=t.history.options.root+"banks",r.fetch({success:function(r){t.trigger("toggleLoading",!1);var i=r.toJSON(),s=e("#hawkAddBankExpFound");n.model=new t.Model({money:{banks:i.data.banks}});if(s.val()==="true"){var o=n.model.get("money");o.banks.hawkAddBankExpFound=s.val(),n.model.set("money",o)}n.afterRender=function(t){e("#contentbanks").html(t),this.moneymodule="undefined",this.bankCount=""},n.render(),n.model.destroy({wait:!0})}}),this.moneymodule="undefined",n.model&&n.model.destroy({wait:!0})},closeAddBankOverpanel:function(){a.isOpen&&a.hideOverpanel(),this.model&&this.model.destroy({wait:!0})},removeServiceErrorMsg:function(){this.$(".alertMsg").remove()},showServiceErrorMsg:function(e){this.removeServiceErrorMsg(),this.$el.find(".overpanel-header").after(this.alertMsg.setMessage(e).el)},showBankDetailsError:function(e){t.trigger("toggleLoading",!1),this.showServiceErrorMsg(e.message)},setupTutorial:function(){e("#banks > ul > li:first-child .section").attr("data-tutorial-title",e("#banksTutorial").data("tutorial-title")).attr("data-tutorial-text",e("#banksTutorial").data("tutorial-text"));var t=function(){setTimeout(n.scrollToTutorial.bind(n,0),1e3)},n=new o(document.body,{close:function(){this.dismissTutorial(),e(document).unbind("ajaxComplete",t),t=null}.bind(this)});e(document).ajaxComplete(t),setTimeout(n.scrollToTutorial.bind(n),0)},initCardsView:function(){this.cardsView||(this.cardsView=new c)},initGiftCardView:function(){this.giftCardsView||(this.giftCardsView=new d)},initMoneyModal:function(){var t=this.$("#moneyTransferModal");t.on("hidden.bs.modal",function(){t.find("iframe").removeAttr("src"),t.find(".modalView").children().empty(),e(".modal-body").removeAttr("style")});var n=window.addEventListener?"addEventListener":"attachEvent",r=window[n],i=n==="attachEvent"?"onmessage":"message";r(i,function(e){switch(e.data){case"reloadCards":this.reloadCards();break;case"reloadGiftCards":this.reloadGiftCards();break;case"reloadBalance":this.reloadBalance();break;case"toggleCloseBtn":this.toggleModalCloseBtn();break;case"closeModal":this.closeMoneyModal(e)}}.bind(this),!1)},reloadCards:function(){this.cardsView&&this.cardsView.fetchData()},reloadGiftCards:function(){this.giftCardsView&&this.giftCardsView.fetchData()},reloadBalance:function(){var t=this,n=e.ajax({url:"/businessexp/money",data:{search:"balances"},method:"GET",dataType:"html",cache:!1});n.done(function(e){t.$("#balance-list").html(e)})},showMoneyTransferModal:function(e){e.preventDefault();var t="/moneytransfer";this.openMoneyModal(t)},addCard:function(){var e="/cards/link/linkcard";this.openMoneyModal(e)},addGiftCards:function(e){e.preventDefault();var t=this.$("#giftCards").data("giftcard-url"),n=t+"/giftcard/link/search";this.openMoneyModal(n)},showCardModal:function(e){e&&typeof e=="string"&&(e=e.slice(0,2)+"-"+e.slice(2,e.length));var t="/cards/card/"+e;this.openMoneyModal(t)},showGiftCardModal:function(t){t.preventDefault();var n=e(t.currentTarget).data("giftcard-id"),r=this.$("#giftCards").data("giftcard-url"),i=r+"/giftcard/edit/"+n;this.openMoneyModal(i)},loadSavedOffers:function(e){var n={savedOffers:this.savedOfferCollection.toJSON()},r=this.$("#moneyTransferModal");this.savedOffersView=this.savedOffersView||new p({model:new t.Model}),this.savedOffersView.model.set("money",n),this.savedOffersView.render(),r.modal("hide")},openSavedOfferDetails:function(t){t.preventDefault();var n=e(t.currentTarget).data("id").toString(),r=this.$("#moneyTransferModal"),i=this.$("#moneyTransferModal .modal-content a.close"),s=this.savedOfferCollection.findWhere({fiId:n}),o="main:businessweb:money:savedOffers:main:viewOffer:",u="main:businessweb:::money",a="bizexpnodeweb/public/templates/money/inc/savedOffer.dust",f=null,l;y.fptiRecordClick(o,u,a,f),i.show(),this.deviceType==="mobile"&&this.$(".modal-body").attr("style","overflow-y: scroll"),this.savedOfferDetails=this.savedOfferDetails||new h({collection:s,model:s}),this.savedOfferDetails.collection=s,this.savedOfferDetails.model=s,l=this.savedOfferDetails,this.openMoneyModal(null,l)},removeAndReloadOffers:function(e){var t=this.savedOfferCollection.findWhere({fiId:e});this.savedOfferCollection.remove(t,{silent:!0}),this.loadSavedOffers()},filterSavedOffers:function(e){var t=this.savedoffers,n;for(n=0;n<=t.length;n++)if(t[n].fiId===e)return t[n]},toggleModalCloseBtn:function(){var e=this.$("#moneyTransferModal");e.toggleClass("hideCloseBtn")},openMoneyModal:function(e,t){var n=this.$("#moneyTransferModal");t?t.render():n.find("iframe").attr("src",e),t?(n.find("iframe").hide(),t.render()):n.find("iframe").show().attr("src",e),n.modal("show")},closeMoneyModal:function(){var e=this.$("#moneyTransferModal");e.modal("hide")},trackClick:function(e){var t="main:businessweb:::money::beta:",n="main:businessweb:::money",r="bizexpnodeweb/public/templates/money/index.dust",i=e.currentTarget.id;y.fptiRecordClick(t,n,r,i)},showRequestIncreaseModal:function(n){n.preventDefault();var r=this.$("#moneyTransferModal"),i=this.$("#moneyTransferModal .modal-dialog .modal-content .modal-body .modal-wrapper"),s=this.$("#moneyTransferModal .modal-content a.close");r.find("iframe").show(),r.modal("show"),i.css("overflow-y","auto"),s.show(),this.deviceType==="mobile"&&this.$(".modal-body").attr("style","overflow-y: scroll"),this.populateChoiceModel=new N({}),this.populateChoiceModel.url=t.history.options.root+"money/populateChoice/",this.populateChoiceModel.fetch({success:function(t,n){var r=new T(n),i=e("#moneyTransferModal");i.find("iframe").hide(),r&&r.render()}})},showSection:!1,toggleHoldSection:function(e){e.preventDefault();var t=this.$(".mobile-specific-holdsection");this.showSection===!1?(t.find("#toggle-div-content").show(),t.find("#caret-up-click").show(),t.find("#caret-down-click").hide(),this.showSection=!0):this.showSection===!0&&(t.find("#toggle-div-content").hide(),t.find("#caret-down-click").show(),t.find("#caret-up-click").hide(),this.showSection=!1)}});return C});