define(["jquery","underscore","backbone","bootstrap","lap","businessHelper","widget/theoverpanel","BaseView","textField","view/overpanel/bank/addBankConfirmBank","widget/alertMsg","widget/validateForm","lib/bb-errors","backboneSyphon"],function(e,t,n,r,i,s,o,u,a,f,l,c){"use strict";var h=u.extend({el:"#bankPage",template:"bank/overpanel/addBank",events:{'submit form[name="bankInfo"]':"saveBankInfo"},initialize:function(){this.alertMsg=this.alertMsg||new l},closeAndRender:function(e){n.trigger("closeAddBankOverpanel"),n.trigger("renderBanks")},beforeRender:function(){},saveBankInfo:function(e){e.preventDefault(),n.trigger("toggleLoading",!0);var t,r;t=new n.Model({parse:function(e){return e.data}}),t.clear();var i=n.Syphon.serialize(this);if(i.iban){var s=i.iban.toUpperCase();i.iban=s;var o=s.slice(0,2);i.country=o}this.listenToOnce(t,"sync",this.saveBankInfoSuccess),this.listenToOnce(t,"error",this.saveBankInfoError),t.url=n.history.options.root+"saveBankInfo",t.set("returnUrl","wallet/add/bank"),t.save(i)},saveBankInfoSuccess:function(e,t){n.trigger("toggleLoading",!1);var r=e.get("data").BANK.state;r==="confirmed"?(n.trigger("closeAddBankOverpanel"),n.trigger("renderBanks")):this.initBankConfirmation(e,t)},initBankConfirmation:function(e,t){var r,i;r=new n.Model({fiId:t.data.BANK.fiId}),this.listenToOnce(r,"sync",this.loadConfirmationView(e,t)),this.listenToOnce(r,"error",this.saveBankInfoError),i=t.data.BANK.confirmationMethod==="double-deposit"?"/initiate-confirmation/double-deposit":"/initiate-confirmation/numeric-code",r.url=n.history.options.root+"banks/"+r.get("fiId")+i,r.save()},loadConfirmationView:function(e,t){n.trigger("toggleLoading",!1);var r=new n.Model({presentation:"addBank",fiId:t.data.BANK.fiId,data:t.data,BANK:t.data.BANK,currencySymbol:t.data.BANK.currencySymbol,confirmationMethod:t.data.BANK.confirmationMethod});t.data.BANK.confirmationMethod!==undefined?(this.addBankConfirmBankView?this.addBankConfirmBankView.model=r:this.addBankConfirmBankView=new f({model:r}),this.addBankConfirmBankView.setElement(this.$el).render()):this.closeAndRender()},removeServiceErrorMsg:function(){this.$(".alertMsg").remove()},saveBankInfoError:function(e,t,r){n.trigger("toggleLoading",!1),t&&n.trigger("trackError",{message:r,code:t.error.code}),this.showServiceErrorMsg(r)},showServiceErrorMsg:function(e){this.alertMsg=this.alertMsg||new l,this.removeServiceErrorMsg(),this.$el.find(".overpanel-header").after(this.alertMsg.setMessage(e).el)},afterRender:function(){this.$(".textInput").lap().textField(),this.addBankformView=new c({el:'form[name="bankInfo"]'}),this.$el.focus()}});return h});